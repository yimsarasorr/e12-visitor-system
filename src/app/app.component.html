<div class="vms-layout">
  <!-- แสดง toolbar เฉพาะเมื่อไม่ใช่ Map view -->
  <p-toolbar styleClass="vms-header" *ngIf="viewMode !== 'map'">
    <ng-template pTemplate="start">
      <div class="header-brand">
        <img src="assets/FastPass_Icon_1.png" alt="Fastpass" class="brand-logo" />
        <div class="brand-copy">
          <span class="brand-title">Fastpass</span>
          <span class="brand-subtitle">ระบบเข้าอาคาร</span>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="end">
      <div class="header-actions">
        <button pButton pRipple type="button" class="p-button-rounded p-button-text header-action">
          <i class="pi pi-bell"></i>
        </button>
        <p-select 
          [options]="(availableUsers$ | async) ?? []"
          optionLabel="role_label" 
          [(ngModel)]="currentUser"
          (onChange)="onUserChange($event.value)"
          styleClass="role-selector"
          placeholder="เลือกผู้ใช้งาน"
          aria-label="เลือกผู้ใช้งานเพื่อทดสอบ"
        >
          <ng-template let-user pTemplate="selectedItem">
            <div class="flex align-items-center gap-2" *ngIf="user">
              <i [class]="user.is_staff ? 'pi pi-id-card' : 'pi pi-user'"></i>
              <div>{{ user.full_name }}</div>
            </div>
          </ng-template>
          <ng-template let-user pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i [class]="user.is_staff ? 'pi pi-id-card' : 'pi pi-user'"></i>
              <div>{{ user.role_label }}</div>
            </div>
          </ng-template>
        </p-select>
      </div>
    </ng-template>
  </p-toolbar>

  <main class="vms-content">
    <ng-container [ngSwitch]="viewMode">
      
      <app-map-view *ngSwitchCase="'map'"></app-map-view>
      
      <ng-container *ngSwitchCase="'building'">
         <div class="building-selection">
            <button type="button" class="back-to-map-btn" (click)="resetToBuildingOverview()">
              <i class="pi pi-arrow-left"></i> กลับไปแผนที่
            </button>

            <div class="selection-canvas">
              <app-building-view
                [floors]="buildingData.floors"
                [activeFloor]="lastActiveFloor"
                (floorSelected)="onFloorDropdownChange($event)"
              ></app-building-view>
            </div>

            <div class="selection-copy">
              <h2>{{ buildingData.buildingName }}</h2>
              <p>เลือกชั้นที่ต้องการเพื่อเข้าชม</p>
            </div>
         </div>
      </ng-container>

      <div *ngSwitchCase="'floor'" class="floor-plan-content">
         <div class="floor-explorer__back-row">
            <button type="button" class="toolbar-back" (click)="resetToBuildingOverview()">
              <i class="pi pi-arrow-left"></i>
              <span>กลับไปเลือกชั้น</span>
            </button>
         </div>

         <app-floor-plan
            [floorData]="selectedFloor"
            [floors]="buildingData.floors"
            [activeFloorValue]="selectedFloorValue"
            (floorChange)="onFloorDropdownChange($event)"
         ></app-floor-plan>
      </div>

    </ng-container>
  </main>

  <app-bottom-sheet></app-bottom-sheet>

  <footer class="vms-footer">
    <button pButton pRipple type="button" class="p-button-text footer-button active">
      <i class="pi pi-compass"></i>
      <span>สำรวจ</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-calendar"></i>
      <span>การจอง</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-bookmark"></i>
      <span>บันทึกแล้ว</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-clock"></i>
      <span>ล่าสุด</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-user"></i>
      <span>โปรไฟล์</span>
    </button>
  </footer>
</div>
