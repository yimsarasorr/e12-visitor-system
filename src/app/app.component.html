<div class="vms-layout">
  <p-toolbar styleClass="vms-header">
    <ng-template pTemplate="start">
      <div class="header-brand">
        <img src="assets/FastPass_Icon_1.png" alt="Fastpass" class="brand-logo" />
        <div class="brand-copy">
          <span class="brand-title">Fastpass</span>
          <span class="brand-subtitle">ระบบเข้าอาคาร</span>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="end">
      <div class="header-actions">
        <button pButton pRipple type="button" class="p-button-rounded p-button-text header-action">
          <i class="pi pi-bell"></i>
        </button>
        <p-select 
          [options]="(availableRoles$ | async) ?? []"
          optionLabel="role"
          optionValue="role"
          [(ngModel)]="selectedRole"
          (onChange)="onRoleChange($event.value)"
          styleClass="role-selector"
          aria-label="เลือก Role ผู้ใช้งาน"
        ></p-select>
      </div>
    </ng-template>
  </p-toolbar>

  <main class="vms-content" [class.floor-active]="!!selectedFloor">
    <section class="search-section">
      <p-inputGroup class="floating-search-bar">
        <span class="p-inputgroup-addon search-addon">
          <i class="pi pi-search"></i>
        </span>
        <input
          pInputText
          type="text"
          [placeholder]="!selectedFloor ? 'ค้นหาอาคารหรือพื้นที่...' : 'ค้นหาในชั้น ' + selectedFloor.floor + '...'"
          aria-label="ค้นหาอาคารหรือสถานที่"
        />
      </p-inputGroup>
    </section>

    <ng-container *ngIf="!isLoading; else loadingState">
      <p-card *ngIf="!selectedFloor" styleClass="overview-card">
        <ng-template pTemplate="content">
          <div class="overview-body">
            <div class="overview__canvas">
              <app-building-view
                [floors]="buildingData.floors"
                [activeFloor]="lastActiveFloor"
                (floorSelected)="onFloorSelected($event)">
              </app-building-view>
            </div>
            <div class="overview__copy">
              <h1>{{ buildingData?.buildingName || 'สำรวจอาคารเรียนรวมวิศวกรรมศาสตร์' }}</h1>
              <p>
                หมุนดูแปลนอาคารก่อนเลือกชั้นที่ต้องการเข้าใช้งาน และบันทึกรายละเอียดไว้สำหรับการจำลอง
                การเข้าออกในระบบ Fastpass
              </p>
            </div>
          </div>
        </ng-template>
      </p-card>

      <p-card *ngIf="selectedFloor" styleClass="floor-card">
        <ng-template pTemplate="content">
          <div class="floor-explorer">
            <div class="floor-explorer__back-row">
              <button type="button" class="toolbar-back" (click)="resetToBuildingOverview()">
                <i class="pi pi-arrow-left"></i>
                <span>กลับไปเลือกอาคาร</span>
              </button>
            </div>
            <div class="floor-explorer__content">
              <aside class="floor-explorer__details">
                <h2>{{ selectedFloor?.floorName || ('ชั้น ' + selectedFloor?.floor) }}</h2>
                <p class="floor-explorer__lead">
                  เลือกชั้นอื่นเพื่อสลับการจำลอง และใช้จอยสติ๊กเพื่อหมุนดูตำแหน่งต่างๆ ของพื้นที่ภายในอาคาร
                </p>
                <div class="floor-explorer__selector" *ngIf="buildingData.floors?.length">
                  <span class="selector-label">เลือกชั้น</span>
                  <p-select
                    [options]="floorOptions"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="selectedFloorValue"
                    [showClear]="true"
                    placeholder="เลือกชั้น"
                    (onChange)="onFloorDropdownChange($event.value)"
                    inputId="floorDropdown"
                    styleClass="floor-dropdown"
                  ></p-select>
                </div>
              </aside>
              <div class="floor-explorer__canvas">
                <app-floor-plan [floorData]="selectedFloor"></app-floor-plan>
              </div>
            </div>
          </div>
        </ng-template>
      </p-card>
    </ng-container>

    <ng-template #loadingState>
      <div class="loading-state">
        <p-progressSpinner styleClass="loading-spinner"></p-progressSpinner>
        <span>กำลังโหลดข้อมูลอาคาร...</span>
      </div>
    </ng-template>
  </main>

  <ng-template #floorWorkspace>
    <div class="panel panel-right floor-plan-content">
      <!-- ...existing code... -->
    </div>
  </ng-template>

  <p-drawer 
    [(visible)]="isDrawerVisible" 
    position="bottom" 
    [styleClass]="isSheetExpanded ? 'access-sheet-drawer sheet-expanded' : 'access-sheet-drawer'"
    [showCloseIcon]="false"
    [modal]="false" 
  >
    <ng-template pTemplate="header">
      <div 
        class="bottom-sheet-header" 
        (click)="toggleSheetState()" 
        (touchstart)="onTouchStart($event)"
        (touchend)="onTouchEnd($event)"
      >
        <div class="bottom-sheet-grabber"></div>
      </div>
    </ng-template>
    <app-access-list></app-access-list>
  </p-drawer>

  <footer class="vms-footer">
    <button pButton pRipple type="button" class="p-button-text footer-button active">
      <i class="pi pi-compass"></i>
      <span>สำรวจ</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-calendar"></i>
      <span>การจอง</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-bookmark"></i>
      <span>บันทึกแล้ว</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-clock"></i>
      <span>ล่าสุด</span>
    </button>
    <button pButton pRipple type="button" class="p-button-text footer-button">
      <i class="pi pi-user"></i>
      <span>โปรไฟล์</span>
    </button>
  </footer>
</div>
